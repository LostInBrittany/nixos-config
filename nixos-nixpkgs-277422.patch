From 8c79e5994e286d521c6a37ee86a35e8bd469037d Mon Sep 17 00:00:00 2001
From: Matt Schreiber <tomeon@dogea.red>
Date: Thu, 28 Dec 2023 16:43:00 -0500
Subject: [PATCH] dropbox: make dropboxd outlive `dropbox-cli start`

by disabling the `--die-with-parent` option to `bwrap`.
---
 pkgs/applications/networking/dropbox/default.nix | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/pkgs/applications/networking/dropbox/default.nix b/pkgs/applications/networking/dropbox/default.nix
index fd48bc86a9b851..c3adfb5a092f9a 100644
--- a/pkgs/applications/networking/dropbox/default.nix
+++ b/pkgs/applications/networking/dropbox/default.nix
@@ -33,6 +33,12 @@ in
 buildFHSEnv {
   name = "dropbox";
 
+  # The dropbox-cli command `dropbox start` starts the dropbox daemon in a
+  # separate session, and wants the daemon to outlive the launcher.  Enabling
+  # `--die-with-parent` defeats this and causes the daemon to exit when
+  # dropbox-cli exits.
+  dieWithParent = false;
+
   # dropbox-cli (i.e. nautilus-dropbox) needs the PID to confirm dropbox is running.
   # Dropbox's internal limit-to-one-instance check also relies on the PID.
   unsharePid = false;
